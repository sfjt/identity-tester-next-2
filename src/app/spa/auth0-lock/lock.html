<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Single Page Application: auth0-lock</title>
  <script src="https://cdn.auth0.com/js/lock/14.0.0/lock.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007bff',
            danger: '#dc3545',
            success: '#28a745',
            secondary: '#6c757d',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: "Roboto", sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 max-w-3xl mx-auto p-5">
  <div class="bg-white p-8 rounded-lg shadow-md">
    <h1 class="text-3xl font-bold text-gray-800 mb-5">Single Page Application: auth0-lock</h1>

    <div class="text-center mb-8" id="loginSection">
      <button id="loginBtn" class="bg-primary text-white border-0 py-3 px-6 rounded-sm cursor-pointer text-base my-2.5 hover:bg-blue-700">Login with Auth0 Lock</button>
      <div id="loading" class="text-center text-gray-600" style="display: none;">Loading Auth0 configuration...</div>
      <div id="error" class="text-danger bg-red-100 p-2.5 rounded-sm my-2.5" style="display: none;"></div>
    </div>

    <div id="userInfo" class="bg-gray-50 p-5 rounded-sm mt-5" style="display: none;">
      <h2 class="text-gray-800 text-xl font-semibold mb-3">Welcome, <span id="userName"></span>!</h2>
      <button id="logoutBtn" class="bg-danger text-white border-0 py-2 px-4 rounded-sm cursor-pointer text-sm hover:bg-red-700">Logout</button>

      <h3 class="text-lg font-semibold mt-4 mb-2">User Profile:</h3>
      <div id="userProfile" class="bg-gray-200 p-4 rounded-sm my-2.5 break-all font-mono text-xs"></div>

      <h3 class="text-lg font-semibold mt-4 mb-2">Access Token:</h3>
      <div id="accessToken" class="bg-gray-200 p-4 rounded-sm my-2.5 break-all font-mono text-xs"></div>

      <h3 class="text-lg font-semibold mt-4 mb-2">ID Token:</h3>
      <div id="idToken" class="bg-gray-200 p-4 rounded-sm my-2.5 break-all font-mono text-xs"></div>
    </div>
  </div>

  <script>
    let lock
    let authConfig
    
    const authData = {
      accessToken: null,
      idToken: null,
      userProfile: null
    }

    function showError(message) {
      document.getElementById("error").textContent = message
      document.getElementById("error").style.display = "block"
    }

    function hideError() {
      document.getElementById("error").style.display = "none"
    }

    function showLoading() {
      document.getElementById("loading").style.display = "block"
      document.getElementById("loginBtn").disabled = true
    }

    function hideLoading() {
      document.getElementById("loading").style.display = "none"
      document.getElementById("loginBtn").disabled = false
    }

    function showUserInfo(profile, accessToken, idToken) {
      document.getElementById("loginSection").style.display = "none"
      document.getElementById("userInfo").style.display = "block"
      
      document.getElementById("userName").textContent = profile.name || profile.email || "User"
      document.getElementById("userProfile").textContent = JSON.stringify(profile, null, 2)
      document.getElementById("accessToken").textContent = accessToken || "N/A"
      document.getElementById("idToken").textContent = idToken || "N/A"
    }

    function showLoginSection() {
      document.getElementById("loginSection").style.display = "block"
      document.getElementById("userInfo").style.display = "none"
    }

    async function fetchAuthConfig() {
      try {
        showLoading()
        hideError()
        
        const response = await fetch("/api/config")
        if (!response.ok) {
          throw new Error("Failed to fetch configuration")
        }
        
        authConfig = await response.json()
        
        if (!authConfig.auth0_domain || !authConfig.spa_client_id) {
          throw new Error("Missing Auth0 configuration")
        }

        initializeLock()
        hideLoading()
        
      } catch (error) {
        console.error("Error fetching auth config:", error)
        showError("Failed to load Auth0 configuration: " + error.message)
        hideLoading()
      }
    }

    function initializeLock() {
      lock = new Auth0Lock(authConfig.spa_client_id, authConfig.auth0_domain, {
        auth: {
          redirectUrl: window.location.origin + "/spa/auth0-lock",
          responseType: "token id_token",
          audience: authConfig.default_audience,
          params: {
            scope: "openid profile email"
          }
        },
        theme: {
          primaryColor: "#007bff"
        },
        languageDictionary: {
          title: "Login to Identity Tester"
        },
        closable: true,
        rememberLastLogin: true
      })

      lock.on("authenticated", function(authResult) {
        console.log("Authentication successful:", authResult)
        
        lock.getUserInfo(authResult.accessToken, function(error, profile) {
          if (error) {
            console.error("Error getting user info:", error)
            showError("Error getting user information: " + error.message)
            return
          }
          
          console.log("User profile:", profile)
          showUserInfo(profile, authResult.accessToken, authResult.idToken)
          
          authData.accessToken = authResult.accessToken
          authData.idToken = authResult.idToken
          authData.userProfile = profile
        })
      })

      lock.on("authorization_error", function(error) {
        console.error("Authorization error:", error)
        showError("Authorization failed: " + error.error_description)
      })

      lock.on("unrecoverable_error", function(error) {
        console.error("Unrecoverable error:", error)
        showError("Login error: " + error.error_description)
      })

      checkExistingAuth()
    }

    function checkExistingAuth() {
      if (authData.accessToken && authData.userProfile) {
        try {
          showUserInfo(authData.userProfile, authData.accessToken, authData.idToken)
        } catch (error) {
          console.error("Error with stored user profile:", error)
          clearStoredAuth()
        }
      }
    }

    function clearStoredAuth() {
      authData.accessToken = null
      authData.idToken = null
      authData.userProfile = null
    }

    function logout() {
      clearStoredAuth()
      showLoginSection()
      
      if (lock) {
        lock.logout({
          returnTo: window.location.origin + "/spa/auth0-lock"
        })
      }
    }

    document.getElementById("loginBtn").addEventListener("click", function() {
      if (lock) {
        lock.show()
      } else {
        showError("Auth0 Lock is not initialized yet. Please wait...")
      }
    })

    document.getElementById("logoutBtn").addEventListener("click", logout)

    window.addEventListener("load", () => {
      fetchAuthConfig()
    })
  </script>
</body>
</html>
