<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Single Page Application: auth0.js</title>
  <script src="https://cdn.auth0.com/js/auth0/9.28.0/auth0.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007bff',
            danger: '#dc3545',
            success: '#28a745',
            secondary: '#6c757d',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: "Roboto", sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 max-w-3xl mx-auto p-5">
  <div class="bg-white p-8 rounded-lg shadow-md">
    <h1 class="text-3xl font-bold text-gray-800 mb-5">Single Page Application: auth0.js</h1>

    <div class="mb-8" id="loginSection">
      <div id="loading" class="text-center text-gray-600" style="display: none;">Loading Auth0 configuration...</div>
      <div id="error" class="text-danger bg-red-100 p-2.5 rounded my-2.5" style="display: none;"></div>
      <div id="success" class="text-green-900 bg-green-100 p-2.5 rounded my-2.5" style="display: none;"></div>

      <div id="authForm" class="bg-gray-50 p-5 rounded my-5" style="display: none;">
        <div class="flex mb-5 rounded overflow-hidden shadow-sm">
          <button id="loginToggle" class="flex-1 py-2.5 px-5 border-0 bg-primary text-white cursor-pointer text-sm transition-all">Login</button>
          <button id="signupToggle" class="flex-1 py-2.5 px-5 border-0 bg-gray-200 text-secondary cursor-pointer text-sm transition-all hover:bg-gray-300">Sign Up</button>
        </div>

        <!-- Login Form -->
        <div id="loginFormContainer">
          <h2 class="text-gray-800 text-xl font-semibold mb-3">Login</h2>
          <form id="databaseLoginForm">
            <div class="mb-4">
              <label for="loginEmail" class="block mb-1 font-medium">Email:</label>
              <input type="email" id="loginEmail" name="email" required class="w-full py-2 px-3 border border-gray-300 rounded text-sm box-border">
            </div>
            <div class="mb-4">
              <label for="loginPassword" class="block mb-1 font-medium">Password:</label>
              <input type="password" id="loginPassword" name="password" required class="w-full py-2 px-3 border border-gray-300 rounded text-sm box-border">
            </div>
            <button type="submit" class="bg-primary text-white border-0 py-3 px-6 rounded cursor-pointer text-base my-2.5 mx-1 w-full hover:bg-blue-700 disabled:bg-secondary disabled:cursor-not-allowed">Login</button>
          </form>
        </div>

        <!-- Signup Form -->
        <div id="signupFormContainer" style="display: none;">
          <h2 class="text-gray-800 text-xl font-semibold mb-3">Sign Up</h2>
          <form id="databaseSignupForm">
            <div class="mb-4">
              <label for="signupEmail" class="block mb-1 font-medium">Email:</label>
              <input type="email" id="signupEmail" name="email" required class="w-full py-2 px-3 border border-gray-300 rounded text-sm box-border">
            </div>
            <div class="mb-4">
              <label for="signupPassword" class="block mb-1 font-medium">Password:</label>
              <input type="password" id="signupPassword" name="password" required class="w-full py-2 px-3 border border-gray-300 rounded text-sm box-border">
            </div>
            <button type="submit" class="bg-primary text-white border-0 py-3 px-6 rounded cursor-pointer text-base my-2.5 mx-1 w-full hover:bg-blue-700 disabled:bg-secondary disabled:cursor-not-allowed">Sign Up</button>
          </form>
        </div>
      </div>
    </div>

    <div id="userInfo" class="bg-gray-50 p-5 rounded mt-5" style="display: none;">
      <h2 class="text-gray-800 text-xl font-semibold mb-3">Welcome, <span id="userName"></span>!</h2>
      <button id="logoutBtn" class="bg-danger text-white border-0 py-2 px-4 rounded cursor-pointer text-sm hover:bg-red-700">Logout</button>

      <h3 class="text-lg font-semibold mt-4 mb-2">User Profile:</h3>
      <div id="userProfile" class="bg-gray-200 p-4 rounded my-2.5 break-all font-mono text-xs"></div>

      <h3 class="text-lg font-semibold mt-4 mb-2">Access Token:</h3>
      <div id="accessToken" class="bg-gray-200 p-4 rounded my-2.5 break-all font-mono text-xs"></div>

      <h3 class="text-lg font-semibold mt-4 mb-2">ID Token:</h3>
      <div id="idToken" class="bg-gray-200 p-4 rounded my-2.5 break-all font-mono text-xs"></div>
    </div>
  </div>

  <script>
    let auth0Client
    let authConfig
    
    const authData = {
      accessToken: null,
      idToken: null,
      userProfile: null
    }

    function showError(message) {
      document.getElementById("error").textContent = message
      document.getElementById("error").style.display = "block"
      document.getElementById("success").style.display = "none"
    }

    function showSuccess(message) {
      document.getElementById("success").textContent = message
      document.getElementById("success").style.display = "block"
      document.getElementById("error").style.display = "none"
    }

    function hideMessages() {
      document.getElementById("error").style.display = "none"
      document.getElementById("success").style.display = "none"
    }

    function showLoading() {
      document.getElementById("loading").style.display = "block"
      document.getElementById("authForm").style.display = "none"
    }

    function hideLoading() {
      document.getElementById("loading").style.display = "none"
      document.getElementById("authForm").style.display = "block"
    }

    function showUserInfo(profile, accessToken, idToken) {
      document.getElementById("loginSection").style.display = "none"
      document.getElementById("userInfo").style.display = "block"
      
      document.getElementById("userName").textContent = profile.name || profile.email || "User"
      document.getElementById("userProfile").textContent = JSON.stringify(profile, null, 2)
      document.getElementById("accessToken").textContent = accessToken || "N/A"
      document.getElementById("idToken").textContent = idToken || "N/A"
    }

    function showLoginSection() {
      document.getElementById("loginSection").style.display = "block"
      document.getElementById("userInfo").style.display = "none"
      hideMessages()
    }

    async function fetchAuthConfig() {
      try {
        showLoading()
        hideMessages()
        
        const response = await fetch("/api/config")
        if (!response.ok) {
          throw new Error("Failed to fetch configuration")
        }
        
        authConfig = await response.json()
        
        if (!authConfig.auth0_domain || !authConfig.spa_client_id) {
          throw new Error("Missing Auth0 configuration")
        }

        initializeAuth0()
        hideLoading()
        
      } catch (error) {
        console.error("Error fetching auth config:", error)
        showError("Failed to load Auth0 configuration: " + error.message)
        hideLoading()
      }
    }

    function initializeAuth0() {
      auth0Client = new auth0.WebAuth({
        domain: authConfig.auth0_domain,
        clientID: authConfig.spa_client_id,
        redirectUri: window.location.origin + "/spa/auth0-js",
        responseType: "token id_token",
        scope: "openid profile email",
        audience: authConfig.default_audience
      })

      checkExistingAuth()
      parseHashAndAuthenticate()
    }

    function parseHashAndAuthenticate() {
      auth0Client.parseHash(function(err, authResult) {
        if (err) {
          console.error("Authentication error:", err)
          showError("Authentication failed: " + err.errorDescription)
          return
        }

        if (authResult && authResult.accessToken && authResult.idToken) {
          console.log("Authentication successful:", authResult)
          
          auth0Client.client.userInfo(authResult.accessToken, function(err, profile) {
            if (err) {
              console.error("Error getting user info:", err)
              showError("Error getting user information: " + err.error_description)
              return
            }
            
            console.log("User profile:", profile)
            showUserInfo(profile, authResult.accessToken, authResult.idToken)
            
            authData.accessToken = authResult.accessToken
            authData.idToken = authResult.idToken
            authData.userProfile = profile

            // Clear hash from URL
            window.location.hash = ""
          })
        }
      })
    }

    function checkExistingAuth() {
      if (authData.accessToken && authData.userProfile) {
        try {
          showUserInfo(authData.userProfile, authData.accessToken, authData.idToken)
        } catch (error) {
          console.error("Error with stored user profile:", error)
          clearStoredAuth()
        }
      }
    }

    function clearStoredAuth() {
      authData.accessToken = null
      authData.idToken = null
      authData.userProfile = null
    }

    function toggleAuthMode(mode) {
      const loginToggle = document.getElementById("loginToggle")
      const signupToggle = document.getElementById("signupToggle")
      const loginContainer = document.getElementById("loginFormContainer")
      const signupContainer = document.getElementById("signupFormContainer")

      if (mode === "login") {
        loginToggle.className = "flex-1 py-2.5 px-5 border-0 bg-primary text-white cursor-pointer text-sm transition-all"
        signupToggle.className = "flex-1 py-2.5 px-5 border-0 bg-gray-200 text-secondary cursor-pointer text-sm transition-all hover:bg-gray-300"
        loginContainer.style.display = "block"
        signupContainer.style.display = "none"
      } else {
        signupToggle.className = "flex-1 py-2.5 px-5 border-0 bg-primary text-white cursor-pointer text-sm transition-all"
        loginToggle.className = "flex-1 py-2.5 px-5 border-0 bg-gray-200 text-secondary cursor-pointer text-sm transition-all hover:bg-gray-300"
        signupContainer.style.display = "block"
        loginContainer.style.display = "none"
      }
    }

    function loginWithDatabase(email, password) {
      hideMessages()
      auth0Client.login({
        realm: "Username-Password-Authentication",
        username: email,
        password: password
      }, function(err, authResult) {
        if (err) {
          console.error("Database login error:", err)
          showError("Login failed: " + err.description)
          return
        }
        
        if (authResult) {
          showSuccess("Login successful! Redirecting...")
          // The parseHash function will handle the result
        }
      })
    }

    function signupWithDatabase(email, password) {
      hideMessages()
      auth0Client.signup({
        connection: "Username-Password-Authentication",
        email: email,
        password: password
      }, function(err, result) {
        if (err) {
          console.error("Database signup error:", err)
          showError("Signup failed: " + err.description)
          return
        }
        
        console.log("Signup successful:", result)
        showSuccess("Account created successfully! You can now login with your credentials.")
        
        // Switch to login form after successful signup
        setTimeout(() => {
          toggleAuthMode("login")
          hideMessages()
        }, 3000)
      })
    }


    function logout() {
      clearStoredAuth()
      showLoginSection()
      
      if (auth0Client) {
        auth0Client.logout({
          returnTo: window.location.origin + "/spa/auth0-js"
        })
      }
    }

    // Toggle between login and signup
    document.getElementById("loginToggle").addEventListener("click", function() {
      toggleAuthMode("login")
    })

    document.getElementById("signupToggle").addEventListener("click", function() {
      toggleAuthMode("signup")
    })

    // Form submissions
    document.getElementById("databaseLoginForm").addEventListener("submit", function(e) {
      e.preventDefault()
      const email = document.getElementById("loginEmail").value
      const password = document.getElementById("loginPassword").value
      loginWithDatabase(email, password)
    })

    document.getElementById("databaseSignupForm").addEventListener("submit", function(e) {
      e.preventDefault()
      const email = document.getElementById("signupEmail").value
      const password = document.getElementById("signupPassword").value
      signupWithDatabase(email, password)
    })

    document.getElementById("logoutBtn").addEventListener("click", logout)

    window.addEventListener("load", () => {
      fetchAuthConfig()
    })
  </script>
</body>
</html>
